<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!-- This file shows how to design a first-run page that provides a welcome screen to the user about the features of the add-in. -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Contoso Task Pane Add-in</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <!-- For more information on Fluent UI, visit https://developer.microsoft.com/fluentui#/. -->
    <link rel="stylesheet" href="https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/office-ui-fabric-core/11.1.0/css/fabric.min.css"/>

    <!-- Template styles -->
    <link href="taskpane.css" rel="stylesheet" type="text/css" />
</head>

<body class="ms-font-m ms-welcome ms-Fabric">
    <!-- Include Choices.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* Container spacing */

        #buttons {
            display: flex;
            flex-direction: row;
            gap: 4px;
            align-items: flex-start; /* Align items to left */
        }

        /* Modern buttons */
        button {
            color: white;
            font-weight: 400;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Refresh button - green */
        #refreshBtn {
            background-color: #275b9f; /* Bootstrap green */
        }
        #refreshBtn:hover {
            background-color: #173760;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }
        #refreshBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Help button - blue */
        #helpBtn {
            background-color: #d80404; /* Fluent UI blue */
        }
        #helpBtn:hover {
            background-color: #B80000;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }
        #helpBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #logoutBtn:hover {
            background-color: #b80000;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }

        #profileSection:hover {
            background-color: #B80000;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }

        /* Modern dropdown styling */
        select {
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            width: 250px; /* decreased width */
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        select:focus {
            border-color: #0078D4;
            box-shadow: 0 0 4px rgba(0,120,212,0.5);
            outline: none;
        }

        .dropdown {
            position: relative;
            width: 280px;
            font-family: Arial, sans-serif;
        }

        .dropdown-toggle {
            padding: 10px 12px;
            width: 250px;
            flex-direction: row;
            align-items: start;
            border: 3px solid #d6e5f5;
            border-radius: 8px;
            cursor: pointer;
            background-color: white;
            font-size: 14px;
        }

        .dropdown-toggle:active {
            border: 3px solid #8bbef4;
        }

        .dropdown-toggle:focus {
            border: 3px solid #8bbef4;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid #8bbef4;
            border-radius: 8px;
            background-color: white;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }

        .dropdown-menu.active {
            display: block;
            border: 1px solid #8bbef4;
            border-radius: 8px;
        }

        

        .dropdown-menu input {
            width: calc(100% - 24px);
            margin: 8px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .dropdown-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .dropdown-menu li {
            padding: 8px 12px;
            cursor: pointer;
        }

        .dropdown-menu li:hover {
            background-color: #f0f0f0;
        }

        .arrow-down {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #000;
        }

        .toggle-container {
            display: flex;
            justify-content: flex-end;  
            margin-bottom: 5px;
            margin-left: 160px;
            margin-top: 40px;
            width: 120px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #e6e6e6;
            border-radius: 10px;
            cursor: pointer;
            width: 120px;   /* slightly smaller than buttons */
            height: 29px;   /* shorter than buttons */
            font-family: Arial, sans-serif;
            font-size: 13px;
            font-weight: 550;
            overflow: hidden;
            position: relative;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }

        .toggle-label:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-option {
            flex: 1;
            text-align: center;
            z-index: 2;
            transition: color 0.3s;
            font-size: 12px; /* slightly smaller text */
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: calc(50% - 4px);
            height: 25px;
            background: #173760;
            border-radius: 8px;
            transition: transform 0.3s;
            z-index: 1;
        }


        #modeToggle {
            display: none;
        }

        #modeToggle:checked + .toggle-label .toggle-slider {
            transform: translateX(100%);
        }

        #modeToggle:checked + .toggle-label .left {
            color: #000;
        }
        #modeToggle:checked + .toggle-label .right {
            color: #fff;
        }

        #modeToggle:not(:checked) + .toggle-label .left {
            color: #fff;
        }
        #modeToggle:not(:checked) + .toggle-label .right {
            color: #000;
        }

        /* Center the entire login container on the page */
        #loginScreen {
            width: 100%;
            max-width: 300px;  /* ensures it never grows too wide */
            display: flex;
            justify-content: start;
            align-items: flex-start;
        }

        #loginWrapper {
            display: flex;
            flex-direction: column;
            align-items: start;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: #f3f4f6;
            padding: 1rem;
            box-sizing: border-box;
        }

        .login-container div {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-start;
        }

        /* White rounded card wrapper */
        #loginScreen .login-container {
            background-color: #ffffff;
            border-radius: 16px;          /* slightly smaller rounding */
            padding: 1.5rem 2rem;         /* reduced padding */
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 360px;             /* reduced width */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header */
        #loginScreen h2 {
            margin-bottom: 1rem;          /* reduced spacing */
            text-align: center;
            font-size: 1.75rem;           /* slightly smaller */
            color: #173760;
        }

        /* Inputs */
        #loginScreen input[type="email"],
        #loginScreen input[type="password"] {
            width: 88%;
            padding: 0.6rem 0.9rem;       /* slightly smaller height */
            border-radius: 10px;          /* smaller radius */
            border: 1px solid #ccc;
            outline: none;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;       /* reduced spacing */
            transition: border 0.2s;
            margin-right: 20px; 
        }

        #loginScreen input:focus {
            border-color: #173760;
        }

        /* Login Button */
        #loginScreen button[type="submit"] {
            width: 100%;
            padding: 0.6rem 0.9rem;       /* smaller height */
            border-radius: 10px;
            background-color: #173760;
            color: #fff;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #loginScreen button[type="submit"]:hover {
            transform: scale(1.03);       /* slightly smaller hover scale */
        }

        /* Divider "OR" */
        #loginScreen .divider {
            display: flex;
            align-items: center;
            gap: 0.3rem;                  /* smaller gap */
            width: 100%;
            margin: 1rem 0;               /* reduced spacing */
        }

        #loginScreen .divider hr {
            flex: 1;
            border-color: #ccc;
        }

        #loginScreen .divider span {
            font-size: 0.8rem;
            color: #999;
        }

        /* Social buttons */
        #loginScreen .social-buttons {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;                 /* smaller gap */
            align-items: center;
        }

        /* Apple Button */
        #loginScreen .apple-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;                  /* smaller gap */
            background-color: #000;
            color: #fff;
            width: 100%;
            padding: 0.45rem 0.8rem;      /* reduced height */
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
        }

        #loginScreen .apple-btn:hover {
            transform: scale(1.03);
        }

        /* Sign-up section */
        #loginScreen .signup {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            
            margin-top: 0.75rem;          /* reduced spacing */
            font-size: 0.8rem;
            color: #173760;
        }

        #loginScreen .signup button {
            background: #173760;
            border: 1px solid #173760;
            border-radius: 10px;
            height: 35px;
            padding: 0.2rem 0.6rem;       /* reduced padding */
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #loginScreen .signup button:hover {
            transform: scale(1.03);
        }

        /* Forgot links */
        #loginScreen .forgot {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;                  /* reduced gap */
            margin-top: 0.5rem;
            width: 100%;
            font-size: 0.75rem;           /* smaller font */
        }

        #loginScreen .forgot button {
            background: none;
            border: none;
            color: #173760;
            cursor: pointer;
            text-align: left;
        }

        #loginScreen .forgot button:hover {
            text-decoration: underline;
        }

        #memberContent,
        #blockedContainer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: start;      /* center horizontally if needed */
            justify-content: start; /* align at the top */
            padding: 1rem;
            box-sizing: border-box;
        }

        #loginSpinner {
            border: 2px solid #f3f3f3; /* Light grey */
            border-top: 2px solid #fff; /* White top part */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin: auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>

    <!-- Login Screen -->
    <div id="loginWrapper" style="display:flex; justify-content:start; align-items:center; min-height:100vh; background:#f3f4f6; flex-direction:column;">
    
        <!-- Login Screen -->
        <div id="loginScreen" style="width:100%; display:none; justify-content:center;">
            <div class="login-container" id="loginContainer">
                <img src="https://www.goindiastocks.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flogo.eb4c0c16.png&w=1920&q=75" 
                alt="App Logo" 
                style="width: 90px; height: 60px; margin-bottom: 10px;" />
                <span style="font-family: 'Open Sans', sans-serif; font-size: 16px; margin-bottom: 12px;">
                    <span style="color: #173760; font-weight: 600;">GO INDIA</span>
                    <span style="color: #B80000; font-weight: 600;"> STOCKS</span>
                </span>
                <form id="loginForm">
                    <input required type="email" name="email" placeholder="Email ID">
                    <input required type="password" name="password" placeholder="Password">
                    <button type="submit" class="login-btn">
                        <span id="loginText">Login</span>
                        <div id="loginSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
                <div class="signup">
                    <p>Don't have an account?</p>
                    <button onclick="window.location.href='https://www.goindiastocks.com/loginpage'">
                        Sign Up
                    </button>
                </div>
            </div>
        </div>

        <!-- Membership / Add-in content -->
        <div id="memberContent" style="display:none;">
            <div id="addinUI" style="display:none;">

                <!-- Profile Section -->
                <a href="https://www.goindiastocks.com/profile" target="_blank" id="profileSection" style="
                    position: absolute;
                    top: 5px;
                    left: 30px;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    background: #ffffff;
                    padding: 0.22rem 0.6rem;
                    border-radius: 10px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    text-decoration: none;
                    color: inherit;
                ">
                    <div id="profileIcon" style="
                        width: 32px;
                        height: 32px;
                        background: #f0f0f0;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        color: #555;
                        font-size: 14px;
                    ">
                        U
                    </div>
                    <span id="username" style="font-size: 14px; color: #333;">Username</span>
                </a>
                
                <!-- Toggle Switch -->
                <div class="toggle-container">
                    <input type="checkbox" id="modeToggle" />
                    <label for="modeToggle" class="toggle-label">
                        <span class="toggle-option left">Detailed</span>
                        <span class="toggle-option right">IndAS</span>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Dropdown -->
                <div class="dropdown" id="customDropdown">
                    <div class="dropdown-toggle" id="dropdownToggle" data-value="">Select Company</div>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <input type="text" id="dropdownSearch" placeholder="Search company..." />
                        <ul id="dropdownList"></ul>
                    </div>
                </div>

                <!-- Buttons -->
                <div id="buttons">
                    <button id="refreshBtn">Refresh</button>
                    <button id="helpBtn">Help</button>
                </div>

                <!-- Log Out Button -->
                <button id="logoutBtn" style="
                    margin-top: 3rem;
                    margin-left: 0;
                    background: #ffffff;
                    color: #b80000;
                    padding: 0.5rem 1rem;
                    border: 1px solid #b80000;
                    border-radius: 12px;
                    cursor: pointer;
                    transition: transform 0.2s, box-shadow 0.2s;
                ">
                    Log Out
                </button>
            </div>
        </div>

        <!-- Blocked / Not a Member -->
        <div id="blockedContainer" style="display:none; text-align:center; padding:2rem; width:100%;">
            <div style="background:white; border-radius:20px; padding:2rem; max-width:400px; margin:auto; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <img src="https://www.goindiastocks.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flogo.eb4c0c16.png&w=1920&q=75" 
                    alt="Membership Required" style="width:100px; margin-bottom:1rem;">
                <p style="color:#b80000; font-weight:bold; margin-bottom:1rem;">Only GIIN Club members can access this add-in.</p>
                <button 
                    onclick="window.open('https://www.goindiastocks.com/pricing', '_blank')" 
                    style="background:#173760; color:white; border:none; padding:0.5rem 1rem; border-radius:12px; cursor:pointer;">
                    Join Now
                </button>
            </div>
        </div>
    </div>

    

    

    <script>
        /*document.addEventListener("DOMContentLoaded", function() {
            // Hide login container
            const loginScreen = document.getElementById("loginScreen");
            if (loginScreen) {
                loginScreen.style.display = "none";
            }

            // Show main content
            const memberContent = document.getElementById("memberContent");
            if (memberContent) {
                memberContent.style.display = "block";
            }

            // Also show the actual add-in UI
            const addinUI = document.getElementById("addinUI");
            if (addinUI) {
                addinUI.style.display = "block";
            }
        });*/
        

        window.onload = function () {
            if (google && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: "588713186952-isq15ehjattbfce2hhhqnuffdfln3nco.apps.googleusercontent.com",
                    callback: handleCredentialResponse
                });

                google.accounts.id.renderButton(
                    document.getElementById("googleSignInButton"),
                    { theme: "outline", size: "large", width: 250 }
                );
            } else {
                console.error("Google Identity Services not loaded yet.");
            }
        };

        async function handleCredentialResponse(response) {
            console.log("Google JWT token:", response.credential);

            try {
                // Step 1: Send Google token to backend to fetch user
                let userRes = await fetch("https://www.goindiastocks.com/api/loginPage/getGoogleuser", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token: response.credential })
                });

                let userData = await userRes.json();
                console.log("User data:", userData);

                // Step 2: Check membership status
                let membershipRes = await fetch("https://transcriptanalyser.com/payment/check_membership", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: userData.email })
                });

                let membership = await membershipRes.json();
                console.log("Membership check:", membership);

                if (membership.is_member === "yes") {
                    document.getElementById("loginContainer").style.display = "none";
                    document.getElementById("memberContent").style.display = "block";
                } else {
                    document.getElementById("loginContainer").style.display = "none";
                    document.getElementById("blockedContainer").style.display = "block";
                }
            } catch (err) {
                console.error("Login or membership check failed:", err);
            }
        }

        function handleCredentialResponse(response) {
            console.log("JWT token:", response.credential);
            // send to your backend for verification
        }
        let companies = [];

        async function fetchCompanies() {
            const response = await fetch("http://localhost:8000/addin/companies");
            const data = await response.json();
            return data;
        }

        function populateCustomDropdown(filteredCompanies) {
            const list = document.getElementById("dropdownList");
            const toggle = document.getElementById("dropdownToggle");

            list.innerHTML = "";

            filteredCompanies.forEach((c, index) => { // Use index to identify the first company
                const li = document.createElement("li");
                li.textContent = c.CompName;
                li.dataset.value = c.fincode;
                li.dataset.sector = c.sector_type;

                // Set the default value for the toggle if it's the first company
                if (index === 0) {
                    toggle.textContent = c.CompName;
                    toggle.dataset.value = c.fincode;
                    toggle.dataset.sector = c.sector_type;
                }

                li.addEventListener("click", () => {
                    toggle.textContent = c.CompName;
                    toggle.dataset.value = c.fincode;
                    toggle.dataset.sector = c.sector_type;
                    document.getElementById("dropdownMenu").classList.remove("active");
                });

                list.appendChild(li);
            });
        }

        async function initCustomDropdown() {
            companies = await fetchCompanies();
            populateCustomDropdown(companies);
        }

        // Toggle dropdown
        document.getElementById("dropdownToggle").addEventListener("click", () => {
            document.getElementById("dropdownMenu").classList.toggle("active");
        });

        // Filter dropdown
        document.getElementById("dropdownSearch").addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = companies.filter(c => c.CompName.toLowerCase().includes(query));
            populateCustomDropdown(filtered);
        });

        // Refresh button
        const showMessage = (msg) => {
            if (Office?.Runtime?.displayDialogAsync) {
                console.log(msg); // fallback for dev
            } else {
                // fallback to alert
                alert(msg);
            }
        };

        // Refresh button
        const getSelectedCompany = () => {
            const toggle = document.getElementById("dropdownToggle");
            if (!toggle) return null;

            const fincode = toggle.dataset?.value || "";
            const name = toggle.textContent?.trim() || "";
            if (!fincode || !name || name === "Select Company") return null;

            return { fincode, name };
        };

        // Refresh button
        document.getElementById("refreshBtn").addEventListener("click", () => {
            const company = getSelectedCompany();
            if (!company) {
                alert("⚠ Please select a company before refreshing.");
                return;
            }

            const { fincode, name } = company;
            // ✅ Get the sector type from the data-sector attribute
            const sector = document.getElementById("dropdownToggle").dataset.sector;
            
            const modeToggle = document.getElementById("modeToggle");
            const mode = modeToggle?.checked ? "In" : "De";

            console.log("Refreshing:", name, "| fincode:", fincode, "| mode:", mode, "| sector:", sector);
        });

        // Help button
        document.getElementById("helpBtn").addEventListener("click", () => {
            const company = getSelectedCompany();
            if (!company) {
                alert("⚠ Please select a company first.");
                return;
            }

            const { fincode } = company;
            const url = `https://www.goindiastocks.com/companyinfo/${encodeURIComponent(fincode)}`;
            window.open(url, "_blank");
        });

        initCustomDropdown();
    </script>
    </main>
</body>

</html>
